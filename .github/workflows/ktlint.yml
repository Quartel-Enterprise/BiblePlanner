name: ktlint

on:
  pull_request:
    paths:
      - '.github/workflows/ktlint.yml'
      - '**/*.kt'
      - '**/*.kts'
      - '.editorconfig'
      - 'build.gradle.kts'
  push:
    branches:
      - main
    paths:
      - '.github/workflows/ktlint.yml'
      - '**/*.kt'
      - '**/*.kts'
      - '.editorconfig'
      - 'build.gradle.kts'

jobs:
  ktlint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install ktlint
        run: |
          curl -sSLO https://github.com/pinterest/ktlint/releases/download/1.8.0/ktlint && 
          chmod a+x ktlint && 
          sudo mv ktlint /usr/local/bin/

      - name: Run ktlint with checkstyle reporter
        run: |
          mkdir -p build
          ktlint --reporter=checkstyle,output=build/ktlint-report.xml || true
        continue-on-error: true

      - name: Generate ktlint report if not exists
        if: "! -f build/ktlint-report.xml"
        run: |
          mkdir -p build
          echo '<?xml version="1.0" encoding="UTF-8"?><checkstyle version="4.3"></checkstyle>' > build/ktlint-report.xml

      - name: Annotate ktlint results
        uses: yutailang0119/action-ktlint@v5
        with:
          report-path: 'build/**/*.xml'
          ignore-warnings: false
        continue-on-error: false

